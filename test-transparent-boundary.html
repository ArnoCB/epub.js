<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Test Transparent Boundary Issue</title>
    <script src="dist/epub.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <style>
      #viewer {
        width: 100%;
        height: 600px;
        border: 1px solid #ccc;
      }
      .controls {
        margin: 20px 0;
      }
      button {
        padding: 10px 20px;
        margin: 0 10px;
      }
      .debug {
        font-family: monospace;
        background: #f0f0f0;
        padding: 10px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="controls">
      <button id="prev">← Previous</button>
      <button id="next">Next →</button>
      <button id="reset">Reset to Chapter 1</button>
    </div>

    <div id="viewer"></div>

    <div id="debug" class="debug">Loading...</div>

    <script>
      // Same setup as transparent-iframe-hightlights.html
      var book = window.ePub(
        'https://s3.amazonaws.com/moby-dick/OPS/package.opf',
        {
          keepAbsoluteUrl: true,
        }
      );

      var rendition = book.renderTo('viewer', {
        width: '100%',
        height: 600,
        ignoreClass: 'annotator-hl',
        manager: 'default',
        flow: 'paginated',
        spread: 'auto',
        transparency: true,
      });

      // Start at spine index 6 (same as the example)
      var displayed = rendition.display(6);

      var debugElement = document.getElementById('debug');

      function updateDebug() {
        const manager = rendition.manager;
        const visible = manager.visible();
        let currentChapter = 'none';
        let hasContent = false;

        if (visible && visible.length > 0) {
          const view = visible[0];
          currentChapter = view.section ? view.section.href : 'unknown';
          if (
            view.contents &&
            view.contents.document &&
            view.contents.document.body
          ) {
            const text = view.contents.document.body.textContent || '';
            hasContent = text.trim().length > 50;
          }
        }

        debugElement.innerHTML = `
        Current: ${currentChapter}<br>
        Has Content: ${hasContent}<br>
        ScrollLeft: ${manager.container.scrollLeft}<br>
        ScrollWidth: ${manager.container.scrollWidth}<br>
        Views: ${visible ? visible.length : 0}
      `;
      }

      rendition.on('relocated', function (location) {
        console.log('🔄 Relocated:', location);
        setTimeout(updateDebug, 100);
      });

      rendition.on('rendered', function () {
        console.log('✅ Rendered');
        setTimeout(updateDebug, 100);
      });

      document.getElementById('prev').addEventListener('click', function () {
        console.log('🔄 Clicking Previous');
        rendition.prev();
      });

      document.getElementById('next').addEventListener('click', function () {
        console.log('🔄 Clicking Next');
        rendition.next();
      });

      document.getElementById('reset').addEventListener('click', function () {
        console.log('🔄 Resetting to Chapter 1');
        rendition.display(6); // Reset to spine index 6
      });

      // Initial debug update
      rendition.on('started', function () {
        console.log('📚 Book started');
        setTimeout(updateDebug, 1000);
      });
    </script>
  </body>
</html>
