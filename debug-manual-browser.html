<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Debug Manual Browser Issue</title>
    <script src="dist/epub.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>

    <style>
      #viewer {
        width: 900px;
        height: 600px;
        margin: 0 auto;
        border: 2px solid #333;
        overflow: hidden;
      }

      #controls {
        text-align: center;
        margin: 20px;
      }

      button {
        padding: 10px 20px;
        margin: 0 10px;
        font-size: 16px;
      }

      #debug {
        margin: 20px;
        font-family: monospace;
        background: #f0f0f0;
        padding: 10px;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <button id="prev">‚Üê Previous</button>
      <button id="next">‚Üí Next</button>
      <button id="debug-btn">üîç Debug State</button>
    </div>

    <div id="viewer"></div>

    <div id="debug">
      <div><strong>Debug Info:</strong></div>
      <div id="debug-content">Loading...</div>
    </div>

    <script>
      console.log('Starting debug manual browser test...');

      // Global state tracking
      window.debugState = {
        clickCount: 0,
        states: [],
      };

      // Load the book (same as manual example)
      var book = window.ePub(
        'https://s3.amazonaws.com/moby-dick/OPS/package.opf',
        {
          keepAbsoluteUrl: true,
        }
      );

      // Create rendition (same as manual example but with spread)
      var rendition = book.renderTo('viewer', {
        width: '100%',
        height: 600,
        ignoreClass: 'annotator-hl',
        manager: 'default',
        flow: 'paginated',
        spread: 'auto',
        transparency: true,
      });

      // Display starting page
      var displayed = rendition.display(6);

      // Add debug logging
      rendition.on('started', function () {
        console.log('üöÄ Rendition started');
        updateDebugInfo();
      });

      rendition.on('relocated', function (location) {
        console.log('üìç Relocated:', location);
        updateDebugInfo();
      });

      // Function to get comprehensive debug info
      function getDebugInfo() {
        const manager = rendition.manager;
        const container = manager.container;
        const layout = rendition.layout;

        const visible = manager.visible();
        let contentAnalysis = 'No content';

        if (visible && visible.length > 0) {
          const view = visible[0];
          if (view && view.contents && view.contents.document) {
            const body = view.contents.document.body;
            const textContent = body ? body.textContent.trim() : '';
            contentAnalysis = `${textContent.length} chars, "${textContent.substring(0, 50)}..."`;
          }
        }

        return {
          clickCount: window.debugState.clickCount,
          scrollLeft: container ? container.scrollLeft : 'N/A',
          scrollWidth: container ? container.scrollWidth : 'N/A',
          offsetWidth: container ? container.offsetWidth : 'N/A',
          layoutDivisor: layout ? layout.divisor : 'N/A',
          layoutWidth: layout ? layout.width : 'N/A',
          visibleViews: visible ? visible.length : 'N/A',
          contentAnalysis: contentAnalysis,
          hasPhantomElement: container
            ? container.querySelector('[data-epub-phantom]')
              ? 'Yes'
              : 'No'
            : 'N/A',
        };
      }

      function updateDebugInfo() {
        setTimeout(() => {
          const info = getDebugInfo();
          const debugDiv = document.getElementById('debug-content');
          debugDiv.innerHTML = `
          <div>Click Count: ${info.clickCount}</div>
          <div>Scroll Left: ${info.scrollLeft}</div>
          <div>Scroll Width: ${info.scrollWidth} (vs container width: ${info.offsetWidth})</div>
          <div>Layout Divisor: ${info.layoutDivisor} (spread=${info.layoutDivisor > 1})</div>
          <div>Layout Width: ${info.layoutWidth}</div>
          <div>Visible Views: ${info.visibleViews}</div>
          <div>Content: ${info.contentAnalysis}</div>
          <div>Phantom Element: ${info.hasPhantomElement}</div>
        `;

          // Store state for comparison
          window.debugState.states[info.clickCount] = info;
        }, 100);
      }

      // Button handlers
      document.getElementById('next').addEventListener('click', function () {
        console.log(`üîÑ Clicking Next (${window.debugState.clickCount + 1})`);
        window.debugState.clickCount++;
        rendition.next();
        updateDebugInfo();
      });

      document.getElementById('prev').addEventListener('click', function () {
        console.log('üîÑ Clicking Previous');
        rendition.prev();
        updateDebugInfo();
      });

      document
        .getElementById('debug-btn')
        .addEventListener('click', function () {
          console.log('üîç Current debug state:', getDebugInfo());
          console.log('üîç All states so far:', window.debugState.states);

          // Check if content is actually visible in viewport
          const container = rendition.manager.container;
          const visible = rendition.manager.visible();

          if (visible && visible.length > 0) {
            const view = visible[0];
            const viewElement = view.element;

            console.log('üîç View element position:', {
              left: viewElement.offsetLeft,
              width: viewElement.offsetWidth,
              containerScrollLeft: container.scrollLeft,
              containerWidth: container.offsetWidth,
              viewComputedStyle: window.getComputedStyle(viewElement),
            });
          }
        });

      // Wait for initial load then update
      displayed.then(() => {
        setTimeout(updateDebugInfo, 500);
      });
    </script>
  </body>
</html>
