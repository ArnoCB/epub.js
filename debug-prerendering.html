<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ePub.js Pre-rendering Demo</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
      }

      #viewer {
        width: 800px;
        height: 600px;
        border: 1px solid #ddd;
        margin: 20px auto;
      }

      .controls {
        text-align: center;
        margin: 20px;
      }

      button {
        margin: 5px;
        padding: 10px 15px;
        font-size: 14px;
      }

      .info {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
        font-family: monospace;
        white-space: pre-wrap;
      }

      .debug-panel {
        background: #f0f0f0;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
        max-height: 400px;
        overflow-y: auto;
      }

      .status {
        display: flex;
        justify-content: space-around;
        margin: 10px 0;
      }

      .status div {
        text-align: center;
      }

      .status .number {
        font-size: 24px;
        font-weight: bold;
        color: #2ecc71;
      }
    </style>
  </head>
  <body>
    <h1>ePub.js Pre-rendering Demo</h1>

    <div class="info" id="info">
      This demo shows how ePub.js can pre-render entire books as off-screen
      elements that can be quickly attached/detached from the DOM for smooth
      navigation. Features: • All chapters pre-rendered on book load • Instant
      chapter switching (no loading delays) • Better debugging with pre-rendered
      chapter inspection • Reduces white page issues during navigation
    </div>

    <div class="controls">
      <button onclick="openBook()">Open Book</button>
      <button onclick="preRenderAll()" id="preRenderBtn" disabled>
        Pre-render All Chapters
      </button>
      <button onclick="prevChapter()" id="prevBtn" disabled>← Previous</button>
      <button onclick="nextChapter()" id="nextBtn" disabled>Next →</button>
      <button onclick="showDebugInfo()">Show Debug Info</button>
    </div>

    <div class="status" id="status" style="display: none">
      <div>
        <div class="number" id="totalChapters">0</div>
        <div>Total Chapters</div>
      </div>
      <div>
        <div class="number" id="renderedChapters">0</div>
        <div>Pre-rendered</div>
      </div>
      <div>
        <div class="number" id="failedChapters">0</div>
        <div>Failed</div>
      </div>
    </div>

    <div id="viewer"></div>

    <div class="debug-panel" id="debugPanel" style="display: none">
      <h3>Debug Information</h3>
      <pre id="debugContent"></pre>
    </div>

    <!-- ePub.js library - in a real implementation, you'd use the built library -->
    <script type="module">
      // Import the necessary classes (adjust paths as needed)
      import Book from './src/book.ts';
      import Rendition from './src/rendition.ts';

      let book = null;
      let rendition = null;
      let currentSection = null;

      // Demo book URL - replace with your own
      const DEMO_BOOK_URL = './examples/books/moby-dick.epub'; // Adjust path as needed

      window.openBook = async function () {
        try {
          updateInfo('Loading book...');

          book = new Book(DEMO_BOOK_URL);
          await book.ready;

          // Create rendition with pre-rendering enabled
          rendition = book.renderTo('viewer', {
            width: '100%',
            height: '100%',
            flow: 'paginated',
            usePreRendering: true, // Enable pre-rendering
          });

          // Display first chapter
          await rendition.display();
          currentSection = book.spine.first();

          updateInfo('Book loaded! Now you can pre-render all chapters.');

          document.getElementById('preRenderBtn').disabled = false;
          updateNavigationButtons();
        } catch (error) {
          updateInfo('Error loading book: ' + error.message);
          console.error(error);
        }
      };

      window.preRenderAll = async function () {
        if (!book || !rendition) {
          updateInfo('Please open a book first');
          return;
        }

        try {
          updateInfo('Pre-rendering all chapters... This may take a moment.');
          document.getElementById('preRenderBtn').disabled = true;

          // Get all spine sections
          const sections = book.spine.spineItems;

          // Pre-render all sections using the view manager
          const manager = rendition.manager;
          if (manager && manager.preRenderAllSections) {
            await manager.preRenderAllSections(sections);

            // Update status
            const debugInfo = manager.preRenderer?.getDebugInfo();
            if (debugInfo) {
              updateStatusDisplay(debugInfo.status);
            }

            updateInfo(
              'Pre-rendering complete! Navigation should now be instant.'
            );
            document.getElementById('prevBtn').disabled = false;
            document.getElementById('nextBtn').disabled = false;
          } else {
            updateInfo('Pre-rendering not supported by current view manager');
          }
        } catch (error) {
          updateInfo('Error during pre-rendering: ' + error.message);
          console.error(error);
        }
      };

      window.nextChapter = function () {
        if (currentSection && currentSection.next) {
          const next = currentSection.next();
          if (next) {
            rendition.display(next.href);
            currentSection = next;
            updateNavigationButtons();
            updateInfo(`Navigated to: ${next.href}`);
          }
        }
      };

      window.prevChapter = function () {
        if (currentSection && currentSection.prev) {
          const prev = currentSection.prev();
          if (prev) {
            rendition.display(prev.href);
            currentSection = prev;
            updateNavigationButtons();
            updateInfo(`Navigated to: ${prev.href}`);
          }
        }
      };

      window.showDebugInfo = function () {
        const debugPanel = document.getElementById('debugPanel');
        const debugContent = document.getElementById('debugContent');

        if (
          !rendition ||
          !rendition.manager ||
          !rendition.manager.preRenderer
        ) {
          debugContent.textContent =
            'No debug information available. Pre-render chapters first.';
        } else {
          const debugInfo = rendition.manager.preRenderer.getDebugInfo();
          debugContent.textContent = JSON.stringify(debugInfo, null, 2);
        }

        debugPanel.style.display =
          debugPanel.style.display === 'none' ? 'block' : 'none';
      };

      function updateInfo(message) {
        document.getElementById('info').textContent = message;
      }

      function updateStatusDisplay(status) {
        document.getElementById('totalChapters').textContent =
          status.total || 0;
        document.getElementById('renderedChapters').textContent =
          status.rendered || 0;
        document.getElementById('failedChapters').textContent =
          status.failed || 0;
        document.getElementById('status').style.display = 'flex';
      }

      function updateNavigationButtons() {
        if (!currentSection) return;

        document.getElementById('prevBtn').disabled =
          !currentSection.prev || !currentSection.prev();
        document.getElementById('nextBtn').disabled =
          !currentSection.next || !currentSection.next();
      }

      // Auto-open book for demo (remove in production)
      // setTimeout(() => openBook(), 1000);
    </script>
  </body>
</html>
