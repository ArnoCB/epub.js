<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Debug Transparent Boundary Navigation</title>
    <script src="dist/epub.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <style>
      #viewer {
        width: 100%;
        height: 600px;
        border: 1px solid #ccc;
      }
      .controls {
        margin: 20px 0;
      }
      button {
        padding: 10px 20px;
        margin: 0 10px;
        font-size: 16px;
      }
      .debug {
        font-family: monospace;
        background: #f0f0f0;
        padding: 10px;
        margin: 10px 0;
        max-height: 400px;
        overflow-y: auto;
      }
      .error {
        background: #ffe6e6;
        color: #cc0000;
      }
      .success {
        background: #e6ffe6;
        color: #006600;
      }
    </style>
  </head>
  <body>
    <div class="controls">
      <button id="prev">‚Üê Previous</button>
      <button id="next">Next ‚Üí</button>
      <button id="reset">Reset to Chapter 1</button>
      <button id="clearLog">Clear Debug Log</button>
    </div>

    <div id="viewer"></div>

    <div id="debug" class="debug">Initializing...</div>

    <script>
      let logCounter = 0;
      let debugElement = document.getElementById('debug');

      function addDebugLog(message, isError = false, isSuccess = false) {
        const timestamp = new Date().toLocaleTimeString();
        const className = isError ? 'error' : isSuccess ? 'success' : '';
        debugElement.innerHTML += `<div class="${className}">[${++logCounter}] ${timestamp}: ${message}</div>`;
        debugElement.scrollTop = debugElement.scrollHeight;
        console.log(`[${logCounter}] ${message}`);
      }

      // Same setup as transparent-iframe-highlights.html
      addDebugLog('Loading EPUB from S3...');
      var book = window.ePub(
        'https://s3.amazonaws.com/moby-dick/OPS/package.opf',
        {
          keepAbsoluteUrl: true,
        }
      );

      var rendition = book.renderTo('viewer', {
        width: '100%',
        height: 600,
        ignoreClass: 'annotator-hl',
        manager: 'default',
        flow: 'paginated',
        spread: 'auto',
        transparency: true,
      });

      // Start at spine index 6 (chapter 1)
      addDebugLog('Starting display at spine index 6...');
      var displayed = rendition.display(6);

      function getDetailedState() {
        const manager = rendition.manager;
        const visible = manager.visible();
        const container = manager.container;

        let state = {
          timestamp: new Date().toLocaleTimeString(),
          hasVisibleViews: visible && visible.length > 0,
          visibleCount: visible ? visible.length : 0,
          scrollLeft: container ? container.scrollLeft : 'N/A',
          scrollWidth: container ? container.scrollWidth : 'N/A',
          offsetWidth: container ? container.offsetWidth : 'N/A',
          currentChapter: 'unknown',
          hasContent: false,
          contentLength: 0,
        };

        if (visible && visible.length > 0) {
          const view = visible[0];
          state.currentChapter = view.section
            ? view.section.href
            : 'no-section';

          try {
            if (
              view.contents &&
              view.contents.document &&
              view.contents.document.body
            ) {
              const text = view.contents.document.body.textContent || '';
              state.contentLength = text.trim().length;
              state.hasContent = state.contentLength > 100;
            }
          } catch (e) {
            state.contentLength = 'error: ' + e.message;
          }
        }

        return state;
      }

      function logCurrentState(action) {
        const state = getDetailedState();
        const isError = !state.hasContent && state.hasVisibleViews;
        const isSuccess = state.hasContent && state.hasVisibleViews;

        addDebugLog(
          `${action} - Chapter: ${state.currentChapter}, Content: ${state.hasContent} (${state.contentLength} chars), Scroll: ${state.scrollLeft}/${state.scrollWidth}, Views: ${state.visibleCount}`,
          isError,
          isSuccess
        );

        return state;
      }

      rendition.on('started', function () {
        addDebugLog('‚úÖ Rendition started', false, true);
        setTimeout(() => logCurrentState('Initial state'), 1000);
      });

      rendition.on('relocated', function (location) {
        setTimeout(() => logCurrentState('After relocation'), 100);
      });

      rendition.on('rendered', function () {
        setTimeout(() => logCurrentState('After render'), 100);
      });

      document.getElementById('prev').addEventListener('click', function () {
        addDebugLog('üîÑ CLICKING PREVIOUS...');
        logCurrentState('Before prev()');
        rendition.prev();
      });

      document.getElementById('next').addEventListener('click', function () {
        addDebugLog('üîÑ CLICKING NEXT...');
        logCurrentState('Before next()');
        rendition.next();
      });

      document.getElementById('reset').addEventListener('click', function () {
        addDebugLog('üîÑ RESETTING TO CHAPTER 1...');
        rendition.display(6);
      });

      document
        .getElementById('clearLog')
        .addEventListener('click', function () {
          debugElement.innerHTML = '<div>Debug log cleared...</div>';
          logCounter = 0;
        });
    </script>
  </body>
</html>
