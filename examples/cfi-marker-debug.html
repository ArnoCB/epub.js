<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>CFI Marker Debug Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #viewer { width: 450px; height: 600px; border: 1px solid #ccc; overflow: auto; }
    #controls { margin: 10px 0; }
    button { margin: 5px; padding: 8px 16px; }
    #log { width: 100%; height: 300px; border: 1px solid #ccc; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; background: #f9f9f9; }
    .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; background: #fff; }
  </style>
</head>
<body>
  <h1>CFI Marker Debug Test</h1>
  
  <div class="debug-section">
    <h3>Status</h3>
    <p id="status">Loading...</p>
  </div>
  
  <div id="controls">
    <button id="debug-contents">Debug Contents Objects</button>
    <button id="test-simple-highlight">Test Simple Highlight</button>
    <button id="test-cfi-markers">Test CFI Markers</button>
    <button id="inspect-views">Inspect Views</button>
  </div>
  
  <div id="viewer"></div>
  
  <h3>Debug Log:</h3>
  <div id="log"></div>

  <script src="../dist/epub.umd.js"></script>
  <script>
    let book, rendition;
    
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
      logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    function updateStatus(text) {
      document.getElementById('status').textContent = text;
      log('Status: ' + text);
    }
    
    function init() {
      updateStatus('Loading EPUB...');
      
      book = window.ePub('https://s3.amazonaws.com/moby-dick/moby-dick.epub');

      rendition = book.renderTo('viewer', {
        width: 450,
        height: 600,
        manager: 'prerendering',
        flow: 'paginated',
        spread: 'none',
        usePreRendering: true
      });

      book.ready.then(() => {
        log('Book ready: ' + book.packaging.metadata.title, 'success');
        updateStatus('Book loaded');
      }).catch((error) => {
        log('Error loading book: ' + error.message, 'error');
        updateStatus('Error loading book');
      });

      rendition.on('started', () => {
        log('Rendition started', 'success');
      });

      rendition.on('attached', () => {
        log('Rendition attached', 'success');
        updateStatus('Rendition attached - ready for testing');
        rendition.display(1);
      });

      rendition.on('rendered', (section) => {
        log('Chapter rendered: ' + section.href, 'success');
        updateStatus('Chapter rendered - ready for CFI tests');
      });
    }
    
    // Debug function to check Contents objects
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('debug-contents').addEventListener('click', () => {
        log('=== CONTENTS DEBUG ===', 'info');
        
        const views = rendition.views();
        log(`Found ${views.length} views`, 'info');
        
        views.forEach((view, index) => {
          log(`View ${index}: index=${view.index}, section=${view.section?.href}`, 'info');
          log(`  - has contents: ${!!view.contents}`, view.contents ? 'success' : 'warning');
          log(`  - has iframe: ${!!view.iframe}`, view.iframe ? 'success' : 'warning');
          log(`  - iframe src: ${view.iframe?.src || 'none'}`, 'info');
          
          if (view.contents) {
            log(`  - contents document: ${!!view.contents.document}`, view.contents.document ? 'success' : 'warning');
            log(`  - contents window: ${!!view.contents.window}`, view.contents.window ? 'success' : 'warning');
          }
        });
      });
      
      // Test simple highlight
      document.getElementById('test-simple-highlight').addEventListener('click', () => {
        log('=== SIMPLE HIGHLIGHT TEST ===', 'info');
        
        if (!rendition.location) {
          log('No location available yet', 'warning');
          return;
        }
        
        const cfi = rendition.location.start.cfi;
        log(`Trying to highlight current location: ${cfi}`, 'info');
        
        try {
          const result = rendition.annotations.highlight(cfi, { test: 'simple' }, () => {
            log('Simple highlight clicked!', 'success');
          }, 'debug-highlight');
          
          log(`Highlight result: ${result ? 'SUCCESS' : 'FAILED'}`, result ? 'success' : 'error');
          
          // Check if highlight actually appeared
          setTimeout(() => {
            const views = rendition.views();
            let found = false;
            views.forEach(view => {
              if (view.iframe && view.iframe.contentDocument) {
                const highlights = view.iframe.contentDocument.querySelectorAll('.debug-highlight, .epubjs-hl');
                if (highlights.length > 0) {
                  log(`Found ${highlights.length} highlight elements in view ${view.index}`, 'success');
                  found = true;
                } else {
                  log(`No highlight elements found in view ${view.index}`, 'warning');
                }
              }
            });
            if (!found) {
              log('No highlight elements found in any view!', 'error');
            }
          }, 100);
          
        } catch (error) {
          log(`Highlight failed: ${error.message}`, 'error');
        }
      });
      
      // Test CFI markers
      document.getElementById('test-cfi-markers').addEventListener('click', () => {
        log('=== CFI MARKERS TEST ===', 'info');
        
        const preRenderer = rendition?.manager?.preRenderer;
        if (!preRenderer) {
          log('No prerenderer available!', 'error');
          return;
        }
        
        const chapters = preRenderer.getAllChapters();
        const currentHref = rendition?.location?.start?.href;
        const chapter = chapters.find(c => c.section.href === currentHref);
        
        if (!chapter || !chapter.pageMap) {
          log(`No chapter or pageMap found for ${currentHref}`, 'error');
          return;
        }
        
        log(`Found chapter with ${chapter.pageMap.length} pages`, 'success');
        
        // Try to add CFI markers for first few pages
        chapter.pageMap.slice(0, 3).forEach((page, i) => {
          log(`Page ${page.index}: startCfi=${page.startCfi?.substring(0, 50)}...`, 'info');
          log(`Page ${page.index}: endCfi=${page.endCfi?.substring(0, 50)}...`, 'info');
          
          if (page.startCfi) {
            try {
              const result = rendition.annotations.highlight(page.startCfi, {
                type: 'cfi-marker',
                pageIndex: page.index,
                pageType: 'start'
              }, () => {
                log(`Start CFI marker clicked for page ${page.index}`, 'success');
              }, 'cfi-marker-start');
              
              log(`Start CFI marker result for page ${page.index}: ${result ? 'SUCCESS' : 'FAILED'}`, result ? 'success' : 'error');
            } catch (error) {
              log(`Start CFI marker failed for page ${page.index}: ${error.message}`, 'error');
            }
          }
        });
      });
      
      // Inspect views
      document.getElementById('inspect-views').addEventListener('click', () => {
        log('=== VIEWS INSPECTION ===', 'info');
        
        const views = rendition.views();
        views.forEach((view, index) => {
          log(`=== VIEW ${index} ===`, 'info');
          log(`  Section: ${view.section?.href}`, 'info');
          log(`  Index: ${view.index}`, 'info');
          log(`  Has iframe: ${!!view.iframe}`, 'info');
          log(`  Has contents: ${!!view.contents}`, 'info');
          log(`  Has pane: ${!!view.pane}`, 'info');
          log(`  Highlights count: ${Object.keys(view.highlights || {}).length}`, 'info');
          
          if (view.iframe && view.iframe.contentDocument) {
            const doc = view.iframe.contentDocument;
            const body = doc.body;
            log(`  Document ready: ${!!doc}`, 'info');
            log(`  Body ready: ${!!body}`, 'info');
            log(`  Text content length: ${body?.textContent?.length || 0}`, 'info');
            
            // Check for any existing annotations
            const annotations = doc.querySelectorAll('.epubjs-hl, .cfi-marker-start, .cfi-marker-end, .debug-highlight');
            log(`  Existing annotations: ${annotations.length}`, 'info');
          }
        });
      });
      
      init();
    });
  </script>
</body>
</html>
